<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Smart Tiffin | Student Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        [x-cloak] { display: none !important; }
    </style>
</head>
<body class="bg-[#f1f5f9]" x-data="{ openSub: false, activePlanName: '', activePlanId: null }">

    <nav class="bg-[#f97316] p-4 text-white flex justify-between items-center shadow-lg sticky top-0 z-40">
        <div class="flex items-center gap-2 px-4">
            <i class="fas fa-utensils text-xl"></i>
            <span class="font-bold text-xl uppercase tracking-tighter">Smart Tiffin</span>
        </div>
        <div class="flex items-center gap-6 px-4">
            <span class="text-sm font-medium">Welcome, <strong th:text="${user.name}" class="uppercase">AMEET</strong></span>
            <a href="/logout" class="bg-white text-orange-600 px-5 py-1.5 rounded-lg text-sm font-bold shadow hover:bg-gray-100 transition">Logout</a>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto p-6 lg:p-10">
        
        <div th:if="${param.error != null and param.error[0] == 'insufficient_funds'}" 
             class="mb-6 p-4 bg-red-100 border-l-4 border-red-500 text-red-700 rounded shadow animate-pulse flex items-center gap-3">
            <i class="fas fa-wallet"></i>
            <p class="font-bold text-sm uppercase">Insufficient Funds! Please add money to your wallet.</p>
        </div>

        <div th:if="${param.success != null}" 
             class="mb-6 p-4 bg-green-100 border-l-4 border-green-500 text-green-700 rounded shadow flex items-center gap-3">
            <i class="fas fa-check-circle"></i>
            <p class="font-bold text-sm uppercase">Order Placed Successfully!</p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            <div class="lg:col-span-8">
                <h2 class="text-2xl font-black text-slate-800 mb-8 uppercase tracking-widest">Available Tiffins</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div th:each="plan : ${plans}" class="bg-white p-8 rounded-[2rem] shadow-sm border border-slate-200">
                        <div class="flex justify-between items-start">
                            <h3 class="text-xl font-black text-slate-900 capitalize" th:text="${plan.planName}">Name</h3>
                            <span class="bg-[#f0fdf4] text-[#16a34a] px-4 py-2 rounded-2xl text-lg font-black border border-green-100">
                                ₹<span th:text="${plan.price}">100.0</span>
                            </span>
                        </div>
                        <p class="mt-4 text-sm text-slate-500 italic" th:text="${plan.description}">Description</p>
                        <button 
                            type="button"
                            th:data-pname="${plan.planName}"
                            th:data-pid="${plan.id}"
                            @click="activePlanName = $el.getAttribute('data-pname'); activePlanId = $el.getAttribute('data-pid'); openSub = true"
                            class="mt-8 block w-full bg-[#0f172a] text-white text-center py-4 rounded-2xl font-black hover:bg-orange-600 transition shadow-lg uppercase text-xs tracking-widest">
                            Subscribe Now
                        </button>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-4 bg-white p-8 rounded-[2rem] shadow-sm border border-slate-100 h-fit sticky top-24">
                <h2 class="text-2xl font-black text-slate-800 mb-8 uppercase tracking-widest">My Orders</h2>
                <div class="space-y-6">
                    <div th:each="order : ${orders}" class="border-l-[6px] p-5 rounded-r-2xl bg-slate-50"
                         th:classappend="${order.status == 'DELIVERED' ? 'border-green-500' : (order.status == 'OUT_FOR_DELIVERY' ? 'border-orange-500' : 'border-blue-400')}">
                        <div class="flex justify-between items-start mb-3">
                            <span class="font-black text-sm text-slate-700 uppercase" th:text="${order.plan.planName}">Meal</span>
                            <span class="text-[10px] text-slate-400 font-bold" th:text="${#temporals.format(order.orderDate, 'dd-MM HH:mm')}">Time</span>
                        </div>
                        <div th:if="${order.status == 'OUT_FOR_DELIVERY'}" class="bg-white border-2 border-green-100 p-4 rounded-xl shadow-inner text-center">
                            <p class="text-[9px] text-slate-400 font-bold uppercase">OTP: <span class="text-2xl text-green-700 tracking-[0.2em] block" th:text="${order.deliveryOtp}">2016</span></p>
                        </div>
                        <div th:if="${order.status == 'DELIVERED'}" class="text-center p-3 bg-blue-50 text-blue-600 rounded-xl font-bold text-[10px] uppercase">
                             Order received successfully
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div x-show="openSub" x-cloak x-transition.opacity class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/70 backdrop-blur-sm">
        <div @click.away="openSub = false" class="bg-slate-900 text-white rounded-[2.5rem] w-full max-w-md shadow-2xl overflow-hidden">
            <div class="p-8 pb-4 flex justify-between items-center border-b border-white/5">
                <h3 class="text-lg font-black uppercase tracking-widest">Subscribe to <span x-text="activePlanName" class="text-orange-400"></span></h3>
                <button @click="openSub = false" class="text-slate-500 hover:text-white"><i class="fas fa-times-circle text-2xl"></i></button>
            </div>
            <div class="p-8 space-y-6">
                <div class="flex justify-between items-center bg-white/5 p-5 rounded-2xl border border-white/5">
                    <div>
                        <p class="text-[9px] text-slate-400 uppercase font-bold tracking-widest">Available Balance</p>
                        <p class="text-lg font-black">₹<span th:text="${user.walletBalance != null ? user.walletBalance : '0.0'}">0.0</span></p>
                    </div>
                    <i class="fas fa-wallet text-orange-400 text-2xl"></i>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <button @click="openSub = false" class="bg-slate-800 py-4 rounded-2xl font-black text-[11px] uppercase">Discard</button>
                    <a :href="'/student/order/' + activePlanId" class="bg-blue-600 py-4 rounded-2xl font-black text-[11px] uppercase text-center shadow-xl hover:bg-blue-500 transition">Confirm</a>
                </div>
            </div>
        </div>
    </div>
</body>
</html>